- name: "RKE2 | Debug first master service failure"
  hosts: gk-rke2-m01.geekops.local
  become: false
  gather_facts: false

  tasks:
    - name: "Debug | systemctl status rke2-server"
      ansible.builtin.command: bash -lc "systemctl status rke2-server --no-pager -l"
      register: svc_status
      changed_when: false
      failed_when: false

    - name: "Debug | journalctl rke2-server (last 200 lines)"
      ansible.builtin.command: bash -lc "journalctl -xeu rke2-server --no-pager -n 200"
      register: svc_journal
      changed_when: false
      failed_when: false

    - name: "Debug | show config.yaml"
      ansible.builtin.command: bash -lc "sed -n '1,200p' /etc/rancher/rke2/config.yaml || true"
      register: cfg
      changed_when: false
      failed_when: false

    - name: "Debug | show registries.yaml"
      ansible.builtin.command: bash -lc "sed -n '1,200p' /etc/rancher/rke2/registries.yaml || true"
      register: regs
      changed_when: false
      failed_when: false

    - name: "Debug | show containerd certs.d CA"
      ansible.builtin.command: bash -lc "ls -l /var/lib/rancher/rke2/agent/etc/containerd/certs.d/harbor.geekops.local/ && openssl x509 -in /var/lib/rancher/rke2/agent/etc/containerd/certs.d/harbor.geekops.local/ca.crt -noout -subject -issuer -dates 2>/dev/null || true"
      register: ca_info
      changed_when: false
      failed_when: false

    - name: "Report | status"
      ansible.builtin.debug:
        var: svc_status.stdout_lines

    - name: "Report | journal"
      ansible.builtin.debug:
        var: svc_journal.stdout_lines

    - name: "Report | config.yaml"
      ansible.builtin.debug:
        var: cfg.stdout_lines

    - name: "Report | registries.yaml"
      ansible.builtin.debug:
        var: regs.stdout_lines

    - name: "Report | certs.d"
      ansible.builtin.debug:
        var: ca_info.stdout_lines
