---
- hosts: all_nodes
  gather_facts: true
  become: true
  tasks:
    # 1. 设置节点主机名（标准化命名）- 修复变量引用
    - name: 设置节点主机名
      hostname:
        name: "{{ node_hostname }}"  # 直接引用节点的node_hostname变量
      tags: hostname

    # 2. 关闭SELinux（RKE2强制要求）
    - name: 临时关闭SELinux
      command: setenforce 0
      ignore_errors: true
      tags: selinux

    - name: 永久关闭SELinux
      lineinfile:
        path: /etc/selinux/config
        regexp: '^SELINUX='
        line: 'SELINUX=disabled'
      tags: selinux

    # 3. 关闭swap分区
    - name: 临时关闭swap
      command: swapoff -a
      ignore_errors: true
      tags: swap

    - name: 永久关闭swap（注释fstab中的swap行）
      replace:
        path: /etc/fstab
        regexp: '^(\s*[^#].*?\sswap\s+.*)$'
        replace: '# \1'
      tags: swap

    # 4. 关闭防火墙
    - name: 停止并禁用firewalld
      systemd:
        name: firewalld
        state: stopped
        enabled: false
      ignore_errors: true
      tags: firewall

    # 5. 安装必备依赖包
    - name: 安装基础依赖包
      dnf:
        name:
          - chrony
          - wget
          - curl
          - tar
          - net-tools
          - ipvsadm
          - ipset
          - conntrack
          - python3
          - python3-pip
        state: present
        update_cache: true
      tags: packages

    # 6. 配置时间同步
    - name: 配置chrony时间同步
      lineinfile:
        path: /etc/chrony.conf
        regexp: '^server .*'
        line: "server {{ ntp_server }} iburst"
      tags: ntp

    - name: 启动并启用chrony服务
      systemd:
        name: chronyd
        state: restarted
        enabled: true
      tags: ntp

    - name: 强制同步时间
      command: chronyc -a makestep
      ignore_errors: true
      tags: ntp

    # 7. 内核参数优化
    - name: 配置内核参数（k8s.conf）
      copy:
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1
          net.ipv4.tcp_tw_recycle             = 0
          vm.swappiness                       = 0
          fs.inotify.max_user_watches         = 89100
          fs.file-max                         = 52706963
          fs.nr_open                          = 52706963
          net.ipv4.tcp_keepalive_time         = 600
          net.ipv4.tcp_keepalive_probes       = 3
          net.ipv4.tcp_keepalive_intvl        = 15
          net.ipv4.tcp_max_tw_buckets         = 36000
          net.ipv4.tcp_tw_reuse               = 1
          net.ipv4.tcp_max_orphans            = 327680
          net.ipv4.tcp_orphan_retries         = 3
          net.ipv4.tcp_syncookies             = 1
          net.ipv4.tcp_fin_timeout            = 30
          net.ipv4.tcp_max_syn_backlog        = 16384
          net.core.somaxconn                  = 16384
          net.core.netdev_max_backlog         = 16384
        dest: /etc/sysctl.d/99-k8s.conf
        mode: 0644
      tags: sysctl

    - name: 加载内核参数
      command: sysctl --system
      tags: sysctl

    # 8. 加载IPVS内核模块
    - name: 配置IPVS内核模块加载
      copy:
        content: |
          ip_vs
          ip_vs_rr
          ip_vs_wrr
          ip_vs_sh
          nf_conntrack
          overlay
          br_netfilter
        dest: /etc/modules-load.d/ipvs.conf
        mode: 0644
      tags: ipvs

    - name: 立即加载IPVS内核模块
      command: "{{ item }}"
      loop:
        - modprobe ip_vs
        - modprobe ip_vs_rr
        - modprobe ip_vs_wrr
        - modprobe ip_vs_sh
        - modprobe nf_conntrack
        - modprobe overlay
        - modprobe br_netfilter
      ignore_errors: true
      tags: ipvs

    # 9. 配置系统限制
    - name: 配置系统资源限制
      copy:
        content: |
          * soft nofile 1048576
          * hard nofile 1048576
          * soft nproc 1048576
          * hard nproc 1048576
          root soft nofile 1048576
          root hard nofile 1048576
          root soft nproc 1048576
          root hard nproc 1048576
        dest: /etc/security/limits.conf
        mode: 0644
      tags: limits

    # 10. 禁用无用服务
    - name: 禁用postfix等无用服务
      systemd:
        name: "{{ item }}"
        state: stopped
        enabled: false
      loop:
        - postfix
        - NetworkManager-wait-online
      ignore_errors: true
      tags: services

    # 11. 系统更新（可选）
    - name: 系统更新（可选）
      dnf:
        name: '*'
        state: latest
      ignore_errors: true
      tags: update

    # 12. 重启节点（可选）
    - name: 重启节点（所有配置生效，注释掉则手动重启）
      reboot:
        msg: "Ansible初始化完成，重启节点生效配置"
        connect_timeout: 5
        reboot_timeout: 600
        pre_reboot_delay: 30
        post_reboot_delay: 60
      tags: reboot
      when: ansible_host is defined

    # 13. 更新hosts记录
    - name: 备份原有/etc/hosts文件
      copy:
        src: /etc/hosts
        dest: /etc/hosts.bak_{{ ansible_date_time.epoch }}
        remote_src: true
        mode: 0644
      tags: hosts

    - name: 配置集群节点hosts解析
      blockinfile:
        path: /etc/hosts
        block: |
          10.228.22.71    gk-rke2-m01 gk-rke2-m01.geekops.local
          10.228.22.72    gk-rke2-m02 gk-rke2-m02.geekops.local
          10.228.22.73    gk-rke2-m03 gk-rke2-m03.geekops.local
          10.228.22.74    gk-rancher-s01 gk-rancher-s01.geekops.local
          10.228.22.15    harbor.geekops.local
        marker: "# {mark} ANSIBLE MANAGED BLOCK - RKE2 CLUSTER HOSTS"
        state: present
        insertafter: EOF  # 追加到hosts文件末尾
        mode: 0644
      tags: hosts
